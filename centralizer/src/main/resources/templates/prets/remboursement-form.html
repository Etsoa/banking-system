<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Centralizer - Paiement Remboursement</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
        <h1>Paiement de Remboursement</h1>
        <div style="margin-bottom: 20px;">
            <a href="/prets" style="color: #007bff; text-decoration: none;">← Retour à la liste des prêts</a>
        </div>

        <!-- Informations du prêt -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3>Informations du Prêt</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><strong>ID Prêt:</strong> <span th:text="${pret.idPret}"></span></div>
                <div><strong>Client:</strong> <span th:text="${pret.idClient}"></span></div>
                <div><strong>Montant Total:</strong> <span th:text="${#numbers.formatCurrency(pret.montant)}"></span></div>
                <div><strong>Statut:</strong> <span th:text="${pretStatut}"></span></div>
            </div>
        </div>

        <!-- Informations du remboursement à effectuer -->
        <div th:if="${prochainRemboursement != null}" 
             style="background: #e7f3ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #007bff;">
            <h3>Prochain Remboursement à Effectuer</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><strong>Période:</strong> <span th:text="${prochainRemboursement.periode}"></span></div>
                <div><strong>Date d'échéance:</strong> <span th:text="${prochainRemboursement.dateEcheance}"></span></div>
                <div><strong>Montant attendu:</strong> <span th:text="${#numbers.formatCurrency(prochainRemboursement.annuite)}" style="font-size: 1.2em; color: #007bff; font-weight: bold;"></span></div>
                <div th:if="${enRetard}"><strong style="color: #dc3545;">Statut:</strong> <span style="color: #dc3545; font-weight: bold;">EN RETARD</span></div>
                <div th:if="${enRetard}"><strong style="color: #dc3545;">Frais de retard actuels:</strong> <span th:text="${#numbers.formatCurrency(fraisRetard)}" style="color: #dc3545; font-weight: bold;"></span></div>
                <div th:if="${enRetard}"><strong style="color: #dc3545;">Total frais payés:</strong> <span th:text="${#numbers.formatCurrency(totalFraisPaye)}" style="color: #dc3545; font-weight: bold;"></span></div>
                <div th:if="${enRetard}"><strong style="color: #dc3545;">Total à payer:</strong> <span th:text="${#numbers.formatCurrency(montantTotalAPayer)}" style="color: #dc3545; font-weight: bold; font-size: 1.2em;"></span></div>
            </div>
        </div>

        <!-- Message si prêt déjà remboursé -->
        <div th:if="${prochainRemboursement == null}" 
             style="background: #d4edda; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
            <h3 style="color: #155724;">Prêt Entièrement Remboursé</h3>
            <p style="color: #155724; margin: 0;">Ce prêt a été entièrement remboursé. Aucun paiement n'est nécessaire.</p>
        </div>

        <!-- Message d'erreur -->
        <div th:if="${error}" style="margin-bottom: 20px; padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; color: #721c24;">
            <strong>Erreur:</strong> <span th:text="${error}"></span>
        </div>

        <!-- Message de succès -->
        <div th:if="${success}" style="margin-bottom: 20px; padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;">
            <strong>Succès:</strong> <span th:text="${success}"></span>
        </div>

        <!-- Formulaire de paiement -->
        <div th:if="${prochainRemboursement != null}">
            <form th:action="@{/prets/{id}/payer(id=${pret.idPret})}" method="post" style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h3>Effectuer le Paiement</h3>
                
                <!-- Date de paiement -->
                <div style="margin-bottom: 20px;">
                    <label for="datePaiement" style="display: block; margin-bottom: 5px; font-weight: bold;">Date de paiement *</label>
                    <input type="date" id="datePaiement" name="datePaiement" 
                           th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
                           required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #6c757d;">Date à laquelle le paiement est effectué</small>
                </div>

                <!-- Montant -->
                <div style="margin-bottom: 20px;">
                    <label for="montant" style="display: block; margin-bottom: 5px; font-weight: bold;">Montant du paiement *</label>
                    <input type="number" step="0.01" id="montant" name="montant" 
                           th:value="${montantTotalAPayer != null ? montantTotalAPayer : prochainRemboursement.annuite}"
                           required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #6c757d;">
                        Montant suggéré: 
                        <span th:if="${!enRetard}" th:text="${#numbers.formatCurrency(prochainRemboursement.annuite)}"></span>
                        <span th:if="${enRetard}" th:text="${#numbers.formatCurrency(montantTotalAPayer)}" style="color: #dc3545; font-weight: bold;"></span>
                    </small>
                </div>

                <!-- Méthode de remboursement -->
                <div style="margin-bottom: 20px;">
                    <label for="idMethodeRemboursement" style="display: block; margin-bottom: 5px; font-weight: bold;">Méthode de remboursement *</label>
                    <select id="idMethodeRemboursement" name="idMethodeRemboursement" required 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">-- Sélectionner une méthode --</option>
                        <option th:each="methode : ${methodesRemboursement}" 
                                th:value="${methode.id}" 
                                th:text="${methode.libelle}"></option>
                    </select>
                </div>

                <!-- Boutons -->
                <div style="margin-top: 30px; text-align: center;">
                    <button type="submit" 
                            style="background-color: #28a745; color: white; border: none; padding: 12px 30px; cursor: pointer; border-radius: 5px; font-size: 16px; margin-right: 10px;">
                        Effectuer le Paiement
                    </button>
                    <a href="/prets" 
                       style="background-color: #6c757d; color: white; text-decoration: none; padding: 12px 30px; border-radius: 5px; font-size: 16px;">
                        Annuler
                    </a>
                </div>
            </form>
        </div>

        <!-- Historique des remboursements -->
        <div th:if="${historique != null and !#lists.isEmpty(historique)}" style="margin-top: 30px;">
            <h3>Historique des Remboursements</h3>
            <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 15px;">
                <thead style="background-color: #f8f9fa;">
                    <tr>
                        <th style="padding: 10px; text-align: left;">Période</th>
                        <th style="padding: 10px; text-align: left;">Date Paiement</th>
                        <th style="padding: 10px; text-align: left;">Montant</th>
                        <th style="padding: 10px; text-align: left;">Jours de Retard</th>
                        <th style="padding: 10px; text-align: left;">Statut</th>
                        <th style="padding: 10px; text-align: left;">Méthode</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="remb : ${historique}" style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 10px;" th:text="${remb.periode}"></td>
                        <td style="padding: 10px;" th:text="${remb.datePaiement != null ? remb.datePaiement : '-'}"></td>
                        <td style="padding: 10px;" th:text="${#numbers.formatCurrency(remb.montant)}"></td>
                        <td style="padding: 10px;" th:text="${remb.joursRetard}"></td>
                        <td style="padding: 10px;" th:text="${remb.statutRemboursement}"></td>
                        <td style="padding: 10px;" th:text="${remb.methodeRemboursement}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Validation côté client
        document.querySelector('form').addEventListener('submit', function(e) {
            const montantInput = document.getElementById('montant');
            const montantSaisi = parseFloat(montantInput.value);
            const montantAttendu = parseFloat(montantInput.getAttribute('th:value') || montantInput.value);
            
            // Vérification que le montant est exact (tolérance de 0.01€)
            if (Math.abs(montantSaisi - montantAttendu) > 0.01) {
                e.preventDefault();
                alert('Le montant saisi doit être exactement égal au montant attendu: ' + montantAttendu.toFixed(2) + '€');
                return false;
            }
            
            return confirm('Êtes-vous sûr de vouloir effectuer ce paiement?');
        });

        // Mise à jour automatique du montant suggéré
        document.addEventListener('DOMContentLoaded', function() {
            const montantInput = document.getElementById('montant');
            const dateInput = document.getElementById('datePaiement');
            
            dateInput.addEventListener('change', function() {
                // Vérifier si la date de paiement est après l'échéance pour recalculer les frais
                // Cette logique peut être étendue avec un appel AJAX si nécessaire
            });
        });
    </script>
</body>
</html>